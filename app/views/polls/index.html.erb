<div class="container">
  <% content_for :title, "Danh sách bình chọn" %>
  <div class="card d-flex flex-row justify-content-between p-3">
    <h3>Danh sách bình chọn</h3>
    <div class=button-header>
      <%= link_to "Trang chủ", root_path, class: "btn btn-secondary"%>
      <% unless user_signed_in? %>
        <%= link_to "Đăng nhập", new_user_session_path, class: "btn btn-primary" %>
      <% end %>
    </div>
  </div>

  <div class="row mt-3">
    <% @polls.each do |poll| %>
    <div class="col-12 col-sm-6 col-md-3 mb-4">
      <div class="card" style="width: 100%;">
        <% if !poll.anonymous && !current_user %>
          <div class="position-absolute top-0 end-0 m-1 bg-dark bg-opacity-75 text-white rounded-circle align-items-center" title="Yêu cầu đăng nhập để bình chọn" style='width: 30px; height: 30px; display: flex; justify-content: center;'>
            <i class="bi bi-lock-fill"></i>
          </div>
        <% end %>
        <% if poll.expires_at.present? %>
          <div class="position-absolute top-0 start-0 bg-dark text-white px-2 py-1 small rounded-end" 
              data-expires-at="<%= poll.expires_at.utc.iso8601 %>">
            <span class="countdown-timer">Đang tải...</span>
          </div>
        <% end %>
        <% if poll.persisted? && poll.image.attached? %>
          <%= image_tag(
                poll.image.variant(resize_to_limit: [180, 180]),
                class: "card-img-top",
                alt: poll.title,
                style: "height: 180px; object-fit: cover;"
              )
          %>
        <% else %>
          <%= image_tag(
                "/images/logo.png",
                class: "card-img-top",
                alt: "No image available",
                style: "height: 180px; object-fit: cover;"
              )
          %>
        <% end %>
        <div class="card-body">
          <h5 class="card-title" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
            <%= poll.title %>
            </h5>
          <p class="card-text" style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"><%= truncate(poll.description, length: 100) %></p>
          <% if poll_expired?(poll) %>
            <span class="btn btn-outline-secondary mt-auto disabled w-100">Hết hạn</span>
          <% elsif user_voted?(poll, current_user) %>
            <span class="btn btn-secondary mt-auto disabled w-100">Đã bình chọn</span>
          <% else %>
            <%= link_to 'Chi tiết', poll_path(poll), class: "btn btn-primary mt-auto w-100" %>
          <% end %>
        </div>
      </div>
    </div>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const timers = document.querySelectorAll("[data-expires-at]");

    timers.forEach(timer => {
      const span = timer.querySelector(".countdown-timer");
      const endTime = new Date(timer.dataset.expiresAt);

      const updateCountdown = () => {
        const now = new Date();
        const diff = endTime - now;

        if (diff <= 0) {
          span.textContent = "Đã hết hạn";
          return;
        }

        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        span.textContent = `${hours}h ${minutes}m ${seconds}s`;
      };

      updateCountdown();
      setInterval(updateCountdown, 1000);
    });
  });
</script>

